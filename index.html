<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEX聚合交易平台</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #0e7bff;
            --primary-dark: #0a5fcc;
            --secondary: #f0f4ff;
            --text: #333;
            --text-light: #666;
            --border: #ddd;
            --background: #fff;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background-color: var(--background);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            background-color: var(--secondary);
            position: relative;
        }

        h1 {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .wallet-connect {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .connect-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wallet-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            border-radius: 20px;
            padding: 6px 12px;
            border: 1px solid var(--border);
        }

        .wallet-address {
            font-size: 0.8rem;
            font-weight: bold;
        }

        .disconnect-btn {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            padding: 5px;
        }

        .network-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .network-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .network-btn.active {
            background: var(--primary);
            color: white;
        }

        .swap-container {
            padding: 20px;
        }

        .token-input {
            background-color: var(--secondary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .token-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .token-label {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .balance {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .amount-selector {
            margin: 10px 0;
        }

        .amount-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .amount-option {
            padding: 6px 10px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .amount-option:hover {
            background: var(--secondary);
        }

        .token-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .token-amount {
            font-size: 1.8rem;
            font-weight: bold;
            border: none;
            background: transparent;
            width: 70%;
            color: var(--text);
            outline: none;
        }

        .token-select {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            border: 1px solid var(--border);
        }

        .token-select:hover {
            border-color: var(--primary);
        }

        .switch-tokens {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .switch-btn {
            background: white;
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .switch-btn:hover {
            border-color: var(--primary);
        }

        .slippage-selector {
            margin: 20px 0;
        }

        .slippage-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .slippage-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .slippage-option {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .slippage-option.active {
            background: var(--primary);
            color: white;
        }

        .price-info {
            background-color: var(--secondary);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            margin-top: 10px;
        }

        .swap-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .swap-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            display: none;
        }

        .notification.success { background: var(--success); }
        .notification.error { background: var(--error); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .token-list {
            list-style: none;
        }

        .token-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .token-item:hover {
            background: var(--secondary);
        }

        .token-symbol {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DEX聚合交易平台</h1>
            <div class="wallet-connect" id="walletConnect">
                <button class="connect-btn" id="connectBtn">
                    <span>连接钱包</span>
                </button>
            </div>
            <div class="network-selector">
                <button class="network-btn active" data-chain="1">以太坊</button>
                <button class="network-btn" data-chain="56">BSC</button>
            </div>
        </header>

        <div class="swap-container">
            <div class="token-input">
                <div class="token-header">
                    <span class="token-label">从</span>
                    <span class="balance">余额: <span id="fromBalance">0.0</span></span>
                </div>
                
                <div class="amount-selector">
                    <div class="amount-options">
                        <div class="amount-option" data-percentage="25">25%</div>
                        <div class="amount-option" data-percentage="50">50%</div>
                        <div class="amount-option" data-percentage="75">75%</div>
                        <div class="amount-option" data-percentage="100">MAX</div>
                    </div>
                </div>
                
                <div class="token-selector">
                    <input type="number" class="token-amount" id="fromAmount" placeholder="0.0" value="0.1" step="0.001">
                    <div class="token-select" id="fromTokenSelect">
                        <span class="token-symbol">ETH</span>
                        <span>▼</span>
                    </div>
                </div>
            </div>

            <div class="switch-tokens">
                <button class="switch-btn" id="switchTokens">⇅</button>
            </div>

            <div class="token-input">
                <div class="token-header">
                    <span class="token-label">到</span>
                    <span class="balance">余额: <span id="toBalance">0.0</span></span>
                </div>
                <div class="token-selector">
                    <input type="text" class="token-amount" id="toAmount" placeholder="0.0" readonly>
                    <div class="token-select" id="toTokenSelect">
                        <span class="token-symbol">USDT</span>
                        <span>▼</span>
                    </div>
                </div>
            </div>

            <div class="slippage-selector">
                <div class="slippage-title">
                    <span>滑点容忍度</span>
                </div>
                <div class="slippage-options">
                    <div class="slippage-option active" data-slippage="1">1%</div>
                    <div class="slippage-option" data-slippage="2">2%</div>
                    <div class="slippage-option" data-slippage="3">3%</div>
                </div>
            </div>

            <div class="price-info">
                <div class="price-row">
                    <span>单价</span>
                    <span id="unitPrice">1 ETH = 0 USDT</span>
                </div>
                <div class="price-row">
                    <span>预计收到</span>
                    <span id="expectedAmount">0 USDT</span>
                </div>
                <button class="refresh-btn" id="refreshPrice">
                    <span>刷新价格</span>
                </button>
            </div>

            <button class="swap-btn" id="swapButton" disabled>连接钱包后开始交易</button>
        </div>
    </div>

    <!-- 代币选择模态框 -->
    <div class="modal" id="tokenModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">选择代币</div>
                <button class="close-modal">&times;</button>
            </div>
            <ul class="token-list" id="tokenList">
                <li class="token-item" data-symbol="ETH" data-address="0x0000000000000000000000000000000000000000">
                    <span class="token-symbol">ETH</span>
                    <span>Ethereum</span>
                </li>
                <li class="token-item" data-symbol="USDT" data-address="0xdAC17F958D2ee523a2206206994597C13D831ec7">
                    <span class="token-symbol">USDT</span>
                    <span>Tether USD</span>
                </li>
                <li class="token-item" data-symbol="USDC" data-address="0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48">
                    <span class="token-symbol">USDC</span>
                    <span>USD Coin</span>
                </li>
                <li class="token-item" data-symbol="DAI" data-address="0x6B175474E89094C44Da98b954EedeAC495271d0F">
                    <span class="token-symbol">DAI</span>
                    <span>Dai Stablecoin</span>
                </li>
            </ul>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // 状态管理
        const state = {
            provider: null,
            signer: null,
            walletAddress: '',
            chainId: '1',
            fromToken: { 
                symbol: 'ETH', 
                address: '0x0000000000000000000000000000000000000000', 
                decimals: 18, 
                balance: 0 
            },
            toToken: { 
                symbol: 'USDT', 
                address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', 
                decimals: 6, 
                balance: 0 
            },
            amount: '0.1',
            slippage: '1',
            selectingToken: null
        };

        // 代币列表
        const TOKENS = {
            '1': [ // 以太坊主网
                { symbol: 'ETH', address: '0x0000000000000000000000000000000000000000', decimals: 18 },
                { symbol: 'USDT', address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals: 6 },
                { symbol: 'USDC', address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48', decimals: 6 },
                { symbol: 'DAI', address: '0x6B175474E89094C44Da98b954EedeAC495271d0F', decimals: 18 }
            ],
            '56': [ // BSC
                { symbol: 'BNB', address: '0x0000000000000000000000000000000000000000', decimals: 18 },
                { symbol: 'BUSD', address: '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56', decimals: 18 },
                { symbol: 'USDT', address: '0x55d398326f99059fF775485246999027B3197955', decimals: 18 }
            ]
        };

        // DOM元素
        const elements = {
            connectBtn: document.getElementById('connectBtn'),
            walletConnect: document.getElementById('walletConnect'),
            fromBalance: document.getElementById('fromBalance'),
            toBalance: document.getElementById('toBalance'),
            fromAmount: document.getElementById('fromAmount'),
            toAmount: document.getElementById('toAmount'),
            fromTokenSelect: document.getElementById('fromTokenSelect'),
            toTokenSelect: document.getElementById('toTokenSelect'),
            switchTokens: document.getElementById('switchTokens'),
            unitPrice: document.getElementById('unitPrice'),
            expectedAmount: document.getElementById('expectedAmount'),
            refreshPrice: document.getElementById('refreshPrice'),
            swapButton: document.getElementById('swapButton'),
            tokenModal: document.getElementById('tokenModal'),
            tokenList: document.getElementById('tokenList'),
            notification: document.getElementById('notification')
        };

        // 初始化
        async function init() {
            setupEventListeners();
            
            // 检查是否已安装MetaMask
            if (typeof window.ethereum !== 'undefined') {
                await checkWalletConnection();
            } else {
                showNotification('请安装MetaMask钱包', 'error');
                elements.connectBtn.textContent = '安装MetaMask';
                elements.connectBtn.onclick = () => {
                    window.open('https://metamask.io/download.html', '_blank');
                };
            }

            await updatePrices();
        }

        // 检查钱包连接状态
        async function checkWalletConnection() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    await connectWallet();
                }
            } catch (error) {
                console.error('检查钱包连接失败:', error);
            }
        }

        // 连接钱包
        async function connectWallet() {
            try {
                // 请求账户访问
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                // 创建provider和signer
                state.provider = new ethers.providers.Web3Provider(window.ethereum);
                state.signer = state.provider.getSigner();
                state.walletAddress = accounts[0];
                
                // 获取网络信息
                const network = await state.provider.getNetwork();
                state.chainId = network.chainId.toString();
                
                // 更新代币列表为当前网络的代币
                updateTokenList();
                
                // 更新UI
                updateWalletUI();
                await updateBalances();
                await updatePrices();
                
                // 监听账户变化
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        state.walletAddress = accounts[0];
                        updateWalletUI();
                        updateBalances();
                    }
                });
                
                // 监听网络变化
                window.ethereum.on('chainChanged', (chainId) => {
                    state.chainId = parseInt(chainId).toString();
                    updateNetworkUI();
                    updateTokenList();
                    updateBalances();
                    updatePrices();
                });
                
                showNotification('钱包连接成功', 'success');
                
            } catch (error) {
                console.error('钱包连接失败:', error);
                showNotification('钱包连接失败: ' + error.message, 'error');
            }
        }

        // 断开钱包连接
        function disconnectWallet() {
            state.provider = null;
            state.signer = null;
            state.walletAddress = '';
            updateWalletUI();
            showNotification('钱包已断开', 'error');
        }

        // 更新钱包UI
        function updateWalletUI() {
            if (state.walletAddress) {
                elements.walletConnect.innerHTML = `
                    <div class="wallet-info">
                        <div class="wallet-address">${state.walletAddress.slice(0, 6)}...${state.walletAddress.slice(-4)}</div>
                        <button class="disconnect-btn" id="disconnectBtn">×</button>
                    </div>
                `;
                document.getElementById('disconnectBtn').onclick = disconnectWallet;
                elements.swapButton.disabled = false;
                elements.swapButton.textContent = '交换';
            } else {
                elements.walletConnect.innerHTML = `
                    <button class="connect-btn" id="connectBtn">
                        <span>连接钱包</span>
                    </button>
                `;
                elements.connectBtn.onclick = connectWallet;
                elements.swapButton.disabled = true;
                elements.swapButton.textContent = '连接钱包后开始交易';
            }
        }

        // 更新网络UI
        function updateNetworkUI() {
            document.querySelectorAll('.network-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.chain === state.chainId) {
                    btn.classList.add('active');
                }
            });
        }

        // 更新代币列表
        function updateTokenList() {
            const tokens = TOKENS[state.chainId] || TOKENS['1'];
            elements.tokenList.innerHTML = '';
            
            tokens.forEach(token => {
                const li = document.createElement('li');
                li.className = 'token-item';
                li.innerHTML = `
                    <span class="token-symbol">${token.symbol}</span>
                    <span>${token.symbol === 'ETH' || token.symbol === 'BNB' ? 'Native Token' : token.symbol}</span>
                `;
                li.dataset.symbol = token.symbol;
                li.dataset.address = token.address;
                li.onclick = () => selectToken(token);
                elements.tokenList.appendChild(li);
            });
        }

        // 选择代币
        function selectToken(token) {
            if (state.selectingToken === 'from') {
                state.fromToken = token;
                elements.fromTokenSelect.querySelector('.token-symbol').textContent = token.symbol;
            } else {
                state.toToken = token;
                elements.toTokenSelect.querySelector('.token-symbol').textContent = token.symbol;
            }
            
            closeTokenModal();
            updateBalances();
            updatePrices();
        }

        // 打开代币选择模态框
        function openTokenModal(type) {
            state.selectingToken = type;
            elements.tokenModal.style.display = 'flex';
        }

        // 关闭代币选择模态框
        function closeTokenModal() {
            elements.tokenModal.style.display = 'none';
            state.selectingToken = null;
        }

        // 更新余额
        async function updateBalances() {
            if (!state.walletAddress || !state.provider) return;
            
            try {
                // 获取原生代币余额（ETH/BNB）
                const nativeBalance = await state.provider.getBalance(state.walletAddress);
                const nativeToken = TOKENS[state.chainId].find(t => t.address === '0x0000000000000000000000000000000000000000');
                
                if (state.fromToken.address === nativeToken.address) {
                    state.fromToken.balance = parseFloat(ethers.utils.formatEther(nativeBalance));
                    elements.fromBalance.textContent = state.fromToken.balance.toFixed(4);
                }
                if (state.toToken.address === nativeToken.address) {
                    state.toToken.balance = parseFloat(ethers.utils.formatEther(nativeBalance));
                    elements.toBalance.textContent = state.toToken.balance.toFixed(4);
                }
                
                // 获取ERC20代币余额
                if (state.fromToken.address !== nativeToken.address) {
                    try {
                        const contract = new ethers.Contract(
                            state.fromToken.address,
                            ['function balanceOf(address) view returns (uint256)'],
                            state.provider
                        );
                        const balance = await contract.balanceOf(state.walletAddress);
                        state.fromToken.balance = parseFloat(ethers.utils.formatUnits(balance, state.fromToken.decimals));
                        elements.fromBalance.textContent = state.fromToken.balance.toFixed(2);
                    } catch (error) {
                        console.error('获取代币余额失败:', error);
                    }
                }
                
                if (state.toToken.address !== nativeToken.address) {
                    try {
                        const contract = new ethers.Contract(
                            state.toToken.address,
                            ['function balanceOf(address) view returns (uint256)'],
                            state.provider
                        );
                        const balance = await contract.balanceOf(state.walletAddress);
                        state.toToken.balance = parseFloat(ethers.utils.formatUnits(balance, state.toToken.decimals));
                        elements.toBalance.textContent = state.toToken.balance.toFixed(2);
                    } catch (error) {
                        console.error('获取代币余额失败:', error);
                    }
                }
                
            } catch (error) {
                console.error('更新余额失败:', error);
            }
        }

        // 获取价格信息
        async function updatePrices() {
            try {
                elements.swapButton.innerHTML = '<div class="loading"></div> 获取价格...';
                elements.swapButton.disabled = true;
                
                const fromAmount = elements.fromAmount.value;
                if (!fromAmount || parseFloat(fromAmount) <= 0) {
                    elements.toAmount.value = '0.0';
                    elements.expectedAmount.textContent = '0 USDT';
                    elements.unitPrice.textContent = '1 ETH = 0 USDT';
                    return;
                }
                
                // 使用1inch API获取报价
                const amountInWei = ethers.utils.parseUnits(fromAmount, state.fromToken.decimals).toString();
                
                const response = await fetch(
                    `https://api.1inch.io/v5.0/${state.chainId}/quote?` +
                    `fromTokenAddress=${state.fromToken.address}&` +
                    `toTokenAddress=${state.toToken.address}&` +
                    `amount=${amountInWei}`
                );
                
                if (!response.ok) {
                    throw new Error('API请求失败');
                }
                
                const data = await response.json();
                
                // 计算预计收到的金额
                const expectedAmount = ethers.utils.formatUnits(data.toTokenAmount, state.toToken.decimals);
                const exchangeRate = parseFloat(expectedAmount) / parseFloat(fromAmount);
                
                elements.toAmount.value = parseFloat(expectedAmount).toFixed(6);
                elements.expectedAmount.textContent = `${parseFloat(expectedAmount).toFixed(2)} ${state.toToken.symbol}`;
                elements.unitPrice.textContent = `1 ${state.fromToken.symbol} = ${exchangeRate.toFixed(6)} ${state.toToken.symbol}`;
                
            } catch (error) {
                console.error('获取价格失败:', error);
                elements.toAmount.value = '0.0';
                elements.expectedAmount.textContent = '获取价格失败';
                elements.unitPrice.textContent = `1 ${state.fromToken.symbol} = 0 ${state.toToken.symbol}`;
                showNotification('获取价格失败，请重试', 'error');
            } finally {
                elements.swapButton.textContent = '交换';
                elements.swapButton.disabled = !state.walletAddress;
            }
        }

        // 执行交换交易
        async function executeSwap() {
            if (!state.signer) {
                showNotification('请先连接钱包', 'error');
                return;
            }
            
            const fromAmount = elements.fromAmount.value;
            if (!fromAmount || parseFloat(fromAmount) <= 0) {
                showNotification('请输入有效的金额', 'error');
                return;
            }
            
            try {
                elements.swapButton.innerHTML = '<div class="loading"></div> 处理中...';
                elements.swapButton.disabled = true;
                
                // 获取交易数据 from 1inch API
                const amountInWei = ethers.utils.parseUnits(fromAmount, state.fromToken.decimals).toString();
                
                const response = await fetch(
                    `https://api.1inch.io/v5.0/${state.chainId}/swap?` +
                    `fromTokenAddress=${state.fromToken.address}&` +
                    `toTokenAddress=${state.toToken.address}&` +
                    `amount=${amountInWei}&` +
                    `fromAddress=${state.walletAddress}&` +
                    `slippage=${state.slippage}`
                );
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.description || '获取交易数据失败');
                }
                
                const data = await response.json();
                
                // 发送交易
                const transaction = await state.signer.sendTransaction({
                    to: data.tx.to,
                    data: data.tx.data,
                    value: data.tx.value,
                    gasLimit: data.tx.gas,
                    gasPrice: data.tx.gasPrice
                });
                
                showNotification('交易已发送，等待确认...', 'success');
                
                // 等待交易确认
                const receipt = await transaction.wait();
                
                showNotification('交易成功！', 'success');
                await updateBalances();
                
            } catch (error) {
                console.error('交易失败:', error);
                showNotification('交易失败: ' + error.message, 'error');
            } finally {
                elements.swapButton.textContent = '交换';
                elements.swapButton.disabled = !state.walletAddress;
            }
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 连接钱包按钮
            elements.connectBtn.onclick = connectWallet;
            
            // 网络切换
            document.querySelectorAll('.network-btn').forEach(btn => {
                btn.onclick = async () => {
                    if (window.ethereum) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: `0x${parseInt(btn.dataset.chain).toString(16)}` }],
                            });
                        } catch (error) {
                            console.error('切换网络失败:', error);
                            showNotification('切换网络失败', 'error');
                        }
                    }
                };
            });
            
            // 代币选择
            elements。fromTokenSelect。onclick = () => openTokenModal('from');
            elements。toTokenSelect。onclick = () => openTokenModal('to');
            
            // 关闭模态框
            document。querySelector('.close-modal')。onclick = closeTokenModal;
            elements。tokenModal。onclick = (e) => {
                if (e.target === elements.tokenModal) {
                    closeTokenModal();
                }
            };
            
            // 金额输入
            elements。fromAmount。addEventListener('input'， () => {
                state。amount = elements。fromAmount。value;
                updatePrices();
            });
            
            // 金额快捷选择
            document。querySelectorAll('.amount-option')。forEach(option => {
                option。onclick = () => {
                    const percentage = parseFloat(option.dataset.percentage) / 100;
                    const maxAmount = state.fromToken.balance * percentage;
                    elements。fromAmount。value = maxAmount。toFixed(6);
                    state。amount = maxAmount。toString();
                    updatePrices();
                };
            });
            
            // 滑点选择
            document.querySelectorAll('.slippage-option')。forEach(option => {
                option.onclick = () => {
                    document.querySelectorAll('.slippage-option')。forEach(opt => {
                        opt.classList。remove('active');
                    });
                    option.classList.add('active');
                    state.slippage = option.dataset.slippage;
                };
            });
            
            // 代币切换
            elements。switchTokens。onclick = () => {
                [state。fromToken， state.toToken] = [state。toToken， state.fromToken];
                elements.fromTokenSelect.querySelector('.token-symbol').textContent = state.fromToken.symbol;
                elements.toTokenSelect.querySelector('.token-symbol')。textContent = state。toToken。symbol;
                updatePrices();
                updateBalances();
            };
            
            // 刷新价格
            elements。refreshPrice。onclick = updatePrices;
            
            // 交换按钮
            elements.swapButton。onclick = executeSwap;
        }

        // 显示通知
        function showNotification(message, type) {
            elements.notification.textContent = message;
            elements.notification.className = `notification ${type}`;
            elements。notification。style。display = 'block';
            
            setTimeout(() => {
                elements.notification.style.display = 'none';
            }, 3000);
        }

        // 初始化应用
        init();
    </script>
</body>
</html>
