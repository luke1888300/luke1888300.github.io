<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MultiDEX Swapper</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.12.1/dist/ethers.umd.min.js"></script>
  <style>
    /* 原有样式保持不变 */
    :root {
      --primary-color: #6c5ce7;
      --secondary-color: #a29bfe;
      --text-color: #2d3436;
      --bg-color: #f5f6fa;
      --card-bg: #ffffff;
      --success-color: #00b894;
      --warning-color: #fdcb6e;
      --error-color: #d63031;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      background-color: var(--card-bg);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary-color);
    }
    .wallet-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .wallet-btn:hover {
      background-color: #5649c0;
    }
    .wallet-info {
      display: flex;
      align-items: center;
      gap: 10px;
      background-color: #f1f1f1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
    }
    .wallet-address {
      font-family: monospace;
    }
    .network-selector {
      margin-top: 10px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background-color: white;
    }
    .swap-container {
      background-color: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .swap-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    .swap-title {
      font-weight: bold;
      font-size: 18px;
    }
    .swap-settings {
      color: var(--primary-color);
      cursor: pointer;
    }
    .token-row {
      display: flex;
      align-items: center;
      background-color: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .token-select {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    .token-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
    }
    .token-symbol {
      font-weight: bold;
    }
    .token-input {
      flex: 1;
      text-align: right;
      border: none;
      background: none;
      font-size: 24px;
      font-weight: bold;
      color: var(--text-color);
    }
    .token-input:focus {
      outline: none;
    }
    .token-balance {
      font-size: 12px;
      color: #7f8c8d;
      text-align: right;
      margin-top: 5px;
    }
    .swap-arrow {
      display: flex;
      justify-content: center;
      margin: 10px 0;
    }
    .swap-arrow-btn {
      background-color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .swap-arrow-btn:hover {
      background-color: #f1f1f1;
    }
    .swap-btn {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      border: none;
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    .swap-btn:disabled {
      background-color: #b2b2b2;
      cursor: not-allowed;
    }
    .swap-btn:hover:not(:disabled) {
      background-color: #5649c0;
    }
    .price-info {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      font-size: 14px;
      color: #7f8c8d;
    }
    .price-value {
      color: var(--text-color);
      font-weight: bold;
    }
    .settings-panel {
      background-color: white;
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      display: none;
    }
    .settings-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .settings-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .settings-label {
      color: #7f8c8d;
    }
    .settings-input {
      width: 80px;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #ddd;
      text-align: right;
    }
    .dex-selector {
      margin-top: 10px;
    }
    .dex-option {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
    }
    .dex-checkbox {
      accent-color: var(--primary-color);
    }
    .token-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    .token-modal-content {
      background-color: white;
      width: 90%;
      max-width: 400px;
      border-radius: 15px;
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .token-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .token-modal-title {
      font-weight: bold;
      font-size: 18px;
    }
    .token-modal-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }
    .token-search {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 15px;
    }
    .token-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .token-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .token-item:hover {
      background-color: #f1f1f1;
    }
    .custom-token {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    .custom-token-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .custom-token-input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 10px;
    }
    .custom-token-btn {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .error-message {
      color: var(--error-color);
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }
    .success-message {
      color: var(--success-color);
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">MultiDEX Swapper</div>
      <button id="connectWalletBtn" class="wallet-btn">
        <i class="fas fa-wallet"></i>
        <span>Connect Wallet</span>
      </button>
      <div id="walletInfo" class="wallet-info" style="display: none;">
        <i class="fas fa-wallet"></i>
        <span id="walletAddress" class="wallet-address"></span>
        <span id="walletBalance"></span>
      </div>
    </div>

    <select id="networkSelector" class="network-selector">
      <option value="1">Ethereum</option>
      <option value="56">Binance Smart Chain</option>
      <option value="137">Polygon</option>
      <option value="42161">Arbitrum</option>
      <option value="10">Optimism</option>
    </select>

    <div class="swap-container">
      <div class="swap-header">
        <div class="swap-title">Swap</div>
        <div class="swap-settings" id="settingsBtn">
          <i class="fas fa-cog"></i>
        </div>
      </div>

      <div class="token-row">
        <div class="token-select" id="fromTokenSelect">
          <img id="fromTokenIcon" class="token-icon" src="https://cryptologos.cc/logos/ethereum-eth-logo.png" alt="ETH">
          <span id="fromTokenSymbol" class="token-symbol">ETH</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <input type="number" id="fromAmount" class="token-input" placeholder="0.0" min="0">
      </div>
      <div class="token-balance" id="fromTokenBalance">Balance: 0</div>

      <div class="swap-arrow">
        <button class="swap-arrow-btn" id="swapDirectionBtn">
          <i class="fas fa-arrow-down"></i>
        </button>
      </div>

      <div class="token-row">
        <div class="token-select" id="toTokenSelect">
          <img id="toTokenIcon" class="token-icon" src="https://cryptologos.cc/logos/usd-coin-usdc-logo.png" alt="USDC">
          <span id="toTokenSymbol" class="token-symbol">USDC</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <input type="number" id="toAmount" class="token-input" placeholder="0.0" min="0" readonly>
      </div>
      <div class="token-balance" id="toTokenBalance">Balance: 0</div>

      <div class="price-info">
        <span>Price</span>
        <span id="exchangeRate" class="price-value">1 ETH = 0 USDC</span>
      </div>

      <button id="swapBtn" class="swap-btn" disabled>
        <span id="swapBtnText">Swap</span>
      </button>

      <div id="errorMessage" class="error-message"></div>
      <div id="successMessage" class="success-message"></div>

      <div id="settingsPanel" class="settings-panel">
        <div class="settings-title">Transaction Settings</div>
        <div class="settings-row">
          <span class="settings-label">Slippage tolerance</span>
          <input type="number" id="slippageInput" class="settings-input" value="1">%
        </div>
        <div class="settings-row">
          <span class="settings-label">Transaction deadline</span>
          <input type="number" id="deadlineInput" class="settings-input" value="20"> mins
        </div>
        <div class="settings-title dex-selector">DEX Aggregators</div>
        <div class="dex-option">
          <input type="checkbox" id="dex1inch" class="dex-checkbox" checked>
          <label for="dex1inch">1inch</label>
        </div>
        <div class="dex-option">
          <input type="checkbox" id="dex0x" class="dex-checkbox" checked>
          <label for="dex0x">0x</label>
        </div>
        <div class="dex-option">
          <input type="checkbox" id="dexKyber" class="dex-checkbox" checked>
          <label for="dexKyber">KyberSwap</label>
        </div>
      </div>
    </div>
  </div>

  <!-- Token Selection Modal -->
  <div id="tokenModal" class="token-modal">
    <div class="token-modal-content">
      <div class="token-modal-header">
        <div class="token-modal-title">Select a token</div>
        <button class="token-modal-close" id="closeTokenModal">&times;</button>
      </div>
      <input type="text" id="tokenSearch" class="token-search" placeholder="Search token name or paste address">
      <div class="token-list" id="tokenList">
        <!-- Tokens will be populated here -->
      </div>
      <div class="custom-token">
        <div class="custom-token-title">Custom Token</div>
        <input type="text" id="customTokenAddress" class="custom-token-input" placeholder="Paste token address">
        <button id="addCustomTokenBtn" class="custom-token-btn">Add Custom Token</button>
      </div>
    </div>
  </div>

  <script>
    // 1. 初始化变量
    let provider;
    let signer;
    let walletAddress = '';
    let currentChainId = 1; // 默认 Ethereum
    let isSwapping = false;
    let selectedTokenSide = 'from'; // 'from' or 'to'
    
    // 2. 常用代币列表（ETH主网）
    const tokenList = [
      {
        address: '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE', // ETH 特殊地址
        symbol: 'ETH',
        name: 'Ethereum',
        decimals: 18,
        logoURI: 'https://cryptologos.cc/logos/ethereum-eth-logo.png'
      },
      {
        address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
        symbol: 'USDC',
        name: 'USD Coin',
        decimals: 6,
        logoURI: 'https://cryptologos.cc/logos/usd-coin-usdc-logo.png'
      },
      {
        address: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
        symbol: 'USDT',
        name: 'Tether',
        decimals: 6,
        logoURI: 'https://cryptologos.cc/logos/tether-usdt-logo.png'
      },
      {
        address: '0x6B175474E89094C44Da98b954EedeAC495271d0F',
        symbol: 'DAI',
        name: 'Dai Stablecoin',
        decimals: 18,
        logoURI: 'https://cryptologos.cc/logos/multi-collateral-dai-dai-logo.png'
      },
      {
        address: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',
        symbol: 'WBTC',
        name: 'Wrapped Bitcoin',
        decimals: 8,
        logoURI: 'https://cryptologos.cc/logos/wrapped-bitcoin-wbtc-logo.png'
      }
    ];
    
    // 3. 当前选择的代币
    let fromToken = tokenList[0]; // ETH
    let toToken = tokenList[1];   // USDC
    
    // 4. DOM 元素
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const walletInfo = document.getElementById('walletInfo');
    const walletAddressEl = document.getElementById('walletAddress');
    const walletBalanceEl = document.getElementById('walletBalance');
    const networkSelector = document.getElementById('networkSelector');
    const fromTokenSelect = document.getElementById('fromTokenSelect');
    const toTokenSelect = document.getElementById('toTokenSelect');
    const fromTokenIcon = document.getElementById('fromTokenIcon');
    const fromTokenSymbol = document.getElementById('fromTokenSymbol');
    const toTokenIcon = document.getElementById('toTokenIcon');
    const toTokenSymbol = document.getElementById('toTokenSymbol');
    const fromAmount = document.getElementById('fromAmount');
    const toAmount = document.getElementById('toAmount');
    const fromTokenBalance = document.getElementById('fromTokenBalance');
    const toTokenBalance = document.getElementById('toTokenBalance');
    const swapDirectionBtn = document.getElementById('swapDirectionBtn');
    const swapBtn = document.getElementById('swapBtn');
    const swapBtnText = document.getElementById('swapBtnText');
    const exchangeRate = document.getElementById('exchangeRate');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const slippageInput = document.getElementById('slippageInput');
    const deadlineInput = document.getElementById('deadlineInput');
    const tokenModal = document.getElementById('tokenModal');
    const tokenSearch = document.getElementById('tokenSearch');
    const tokenListEl = document.getElementById('tokenList');
    const closeTokenModal = document.getElementById('closeTokenModal');
    const customTokenAddress = document.getElementById('customTokenAddress');
    const addCustomTokenBtn = document.getElementById('addCustomTokenBtn');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    
    // 5. 初始化事件监听器
    function initEventListeners() {
      // 连接钱包按钮
      connectWalletBtn.addEventListener('click', connectWallet);
      
      // 网络切换
      networkSelector.addEventListener('change', handleNetworkChange);
      
      // 代币选择
      fromTokenSelect.addEventListener('click', () => {
        selectedTokenSide = 'from';
        showTokenModal();
      });
      
      toTokenSelect.addEventListener('click', () => {
        selectedTokenSide = 'to';
        showTokenModal();
      });
      
      // 交换方向按钮
      swapDirectionBtn.addEventListener('click', swapTokens);
      
      // 数量输入
      fromAmount.addEventListener('input', debounce(updateQuote, 500));
      
      // 设置按钮
      settingsBtn.addEventListener('click', toggleSettingsPanel);
      
      // 关闭代币选择模态框
      closeTokenModal.addEventListener('click', hideTokenModal);
      
      // 代币搜索
      tokenSearch.addEventListener('input', filterTokenList);
      
      // 添加自定义代币
      addCustomTokenBtn.addEventListener('click', addCustomToken);
      
      // 执行兑换
      swapBtn.addEventListener('click', executeSwap);
    }
    
    // 6. 连接钱包函数
    async function connectWallet() {
      try {
        // 检查是否安装了 MetaMask
        if (window.ethereum) {
          // 请求账户访问
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          
          // 初始化 ethers.js provider 和 signer
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();
          walletAddress = accounts[0];
          
          // 获取当前链ID
          currentChainId = parseInt(await window.ethereum.request({ method: 'eth_chainId' }), 16);
          networkSelector.value = currentChainId.toString();
          
          // 更新UI显示钱包信息
          updateWalletInfo();
          
          // 监听账户变化
          window.ethereum.on('accountsChanged', (newAccounts) => {
            if (newAccounts.length > 0) {
              walletAddress = newAccounts[0];
              updateWalletInfo();
              updateTokenBalances();
            } else {
              // 用户断开连接
              disconnectWallet();
            }
          });
          
          // 监听链变化
          window.ethereum.on('chainChanged', (chainId) => {
            currentChainId = parseInt(chainId, 16);
            networkSelector.value = currentChainId.toString();
            updateWalletInfo();
            updateTokenBalances();
          });
          
          // 获取代币余额
          updateTokenBalances();
          
          // 更新按钮状态
          connectWalletBtn.style.display = 'none';
          walletInfo.style.display = 'flex';
          
          // 显示成功消息
          showSuccessMessage('Wallet connected successfully');
        } else {
          throw new Error('MetaMask not detected. Please install MetaMask to use this app.');
        }
      } catch (error) {
        showErrorMessage(error.message);
        console.error('Error connecting wallet:', error);
      }
    }
    
    // 7. 断开钱包连接
    function disconnectWallet() {
      walletAddress = '';
      provider = null;
      signer = null;
      
      // 更新UI
      connectWalletBtn.style.display = 'block';
      walletInfo.style.display = 'none';
      fromTokenBalance.textContent = 'Balance: 0';
      toTokenBalance.textContent = 'Balance: 0';
      
      // 重置输入
      fromAmount.value = '';
      toAmount.value = '';
      exchangeRate.textContent = '1 ETH = 0 USDC';
      
      // 禁用兑换按钮
      swapBtn.disabled = true;
    }
    
    // 8. 更新钱包信息
    async function updateWalletInfo() {
      if (!provider || !walletAddress) return;
      
      try {
        // 显示钱包地址（缩短）
        const shortAddress = `${walletAddress.substring(0, 6)}...${walletAddress.substring(walletAddress.length - 4)}`;
        walletAddressEl.textContent = shortAddress;
        
        // 获取ETH余额
        const balance = await provider.getBalance(walletAddress);
        const ethBalance = ethers.formatEther(balance);
        walletBalanceEl.textContent = `${parseFloat(ethBalance).toFixed(4)} ETH`;
      } catch (error) {
        console.error('Error updating wallet info:', error);
      }
    }
    
    // 9. 更新代币余额
    async function updateTokenBalances() {
      if (!provider || !walletAddress) return;
      
      try {
        // 更新fromToken余额
        if (fromToken.symbol === 'ETH') {
          const balance = await provider.getBalance(walletAddress);
          const ethBalance = ethers.formatEther(balance);
          fromTokenBalance.textContent = `Balance: ${parseFloat(ethBalance).toFixed(4)} ETH`;
        } else {
          // ERC20代币余额
          const tokenContract = new ethers.Contract(
            fromToken.address,
            ['function balanceOf(address) view returns (uint256)'],
            provider
          );
          const balance = await tokenContract.balanceOf(walletAddress);
          const formattedBalance = ethers.formatUnits(balance, fromToken.decimals);
          fromTokenBalance.textContent = `Balance: ${parseFloat(formattedBalance).toFixed(4)} ${fromToken.symbol}`;
        }
        
        // 更新toToken余额
        if (toToken.symbol === 'ETH') {
          const balance = await provider.getBalance(walletAddress);
          const ethBalance = ethers.formatEther(balance);
          toTokenBalance.textContent = `Balance: ${parseFloat(ethBalance).toFixed(4)} ETH`;
        } else {
          // ERC20代币余额
          const tokenContract = new ethers.Contract(
            toToken.address,
            ['function balanceOf(address) view returns (uint256)'],
            provider
          );
          const balance = await tokenContract.balanceOf(walletAddress);
          const formattedBalance = ethers.formatUnits(balance, toToken.decimals);
          toTokenBalance.textContent = `Balance: ${parseFloat(formattedBalance).toFixed(4)} ${toToken.symbol}`;
        }
      } catch (error) {
        console.error('Error updating token balances:', error);
      }
    }
    
    // 10. 处理网络切换
    async function handleNetworkChange() {
      const newChainId = parseInt(networkSelector.value);
      
      try {
        // 请求切换网络
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: `0x${newChainId.toString(16)}` }],
        });
        
        // 更新当前链ID
        currentChainId = newChainId;
      } catch (error) {
        console.error('Error switching network:', error);
        networkSelector.value = currentChainId.toString(); // 恢复之前的选择
        showErrorMessage(`Failed to switch network: ${error.message}`);
      }
    }
    
    // 11. 显示代币选择模态框
    function showTokenModal() {
      // 填充代币列表
      populateTokenList();
      
      // 显示模态框
      tokenModal.style.display = 'flex';
    }
    
    // 12. 隐藏代币选择模态框
    function hideTokenModal() {
      tokenModal.style.display = 'none';
    }
    
    // 13. 填充代币列表
    function populateTokenList() {
      tokenListEl.innerHTML = '';
      
      tokenList.forEach(token => {
        const tokenItem = document.createElement('div');
        tokenItem.className = 'token-item';
        tokenItem.innerHTML = `
          <img src="${token.logoURI}" alt="${token.symbol}" width="24" height="24">
          <div>
            <div>${token.symbol}</div>
            <div style="font-size: 12px; color: #7f8c8d;">${token.name}</div>
          </div>
        `;
        
        tokenItem.addEventListener('click', () => {
          selectToken(token);
          hideTokenModal();
        });
        
        tokenListEl.appendChild(tokenItem);
      });
    }
    
    // 14. 过滤代币列表
    function filterTokenList() {
      const searchTerm = tokenSearch.value.toLowerCase();
      const tokenItems = tokenListEl.querySelectorAll('.token-item');
      
      tokenItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }
    
    // 15. 选择代币
    function selectToken(token) {
      if (selectedTokenSide === 'from') {
        fromToken = token;
        fromTokenIcon.src = token.logoURI;
        fromTokenSymbol.textContent = token.symbol;
      } else {
        toToken = token;
        toTokenIcon.src = token.logoURI;
        toTokenSymbol.textContent = token.symbol;
      }
      
      // 更新余额
      updateTokenBalances();
      
      // 如果输入了金额，重新获取报价
      if (fromAmount.value) {
        updateQuote();
      }
    }
    
    // 16. 添加自定义代币
    function addCustomToken() {
      const address = customTokenAddress.value.trim();
      
      if (!address) {
        showErrorMessage('Please enter a token address');
        return;
      }
      
      if (!ethers.isAddress(address)) {
        showErrorMessage('Invalid token address');
        return;
      }
      
      // 这里应该调用API获取代币信息，但为了简化，我们只添加一个占位符
      const customToken = {
        address: address,
        symbol: 'CUSTOM',
        name: 'Custom Token',
        decimals: 18,
        logoURI: 'https://cryptologos.cc/logos/ethereum-eth-logo.png' // 默认图标
      };
      
      // 添加到代币列表
      tokenList.push(customToken);
      
      // 选择这个代币
      selectToken(customToken);
      
      // 清空输入
      customTokenAddress.value = '';
      
      // 隐藏模态框
      hideTokenModal();
    }
    
    // 17. 交换代币方向
    function swapTokens() {
      // 交换代币
      const tempToken = fromToken;
      fromToken = toToken;
      toToken = tempToken;
      
      // 更新UI
      fromTokenIcon.src = fromToken.logoURI;
      fromTokenSymbol.textContent = fromToken.symbol;
      toTokenIcon.src = toToken.logoURI;
      toTokenSymbol.textContent = toToken.symbol;
      
      // 交换金额
      const tempAmount = fromAmount.value;
      fromAmount.value = toAmount.value;
      toAmount.value = tempAmount;
      
      // 更新余额
      updateTokenBalances();
      
      // 如果输入了金额，重新获取报价
      if (fromAmount.value) {
        updateQuote();
      }
    }
    
    // 18. 更新报价（调用1inch API）
    async function updateQuote() {
      if (!fromAmount.value || parseFloat(fromAmount.value) <= 0) {
        toAmount.value = '';
        exchangeRate.textContent = `1 ${fromToken.symbol} = 0 ${toToken.symbol}`;
        swapBtn.disabled = true;
        return;
      }
      
      if (!walletAddress) {
        showErrorMessage('Please connect your wallet first');
        return;
      }
      
      if (fromToken.address === toToken.address) {
        showErrorMessage('Cannot swap the same token');
        return;
      }
      
      try {
        // 显示加载状态
        swapBtn.disabled = true;
        swapBtnText.innerHTML = '<div class="loading"></div>';
        
        // 获取滑点设置
        const slippage = parseFloat(slippageInput.value) || 1;
        
        // 构建1inch API URL
        const chainId = currentChainId;
        let apiUrl;
        
        if (chainId === 1) {
          apiUrl = 'https://api.1inch.io/v5.0/1';
        } else if (chainId === 56) {
          apiUrl = 'https://api.1inch.io/v5.0/56';
        } else if (chainId === 137) {
          apiUrl = 'https://api.1inch.io/v5.0/137';
        } else if (chainId === 42161) {
          apiUrl = 'https://api.1inch.io/v5.0/42161';
        } else if (chainId === 10) {
          apiUrl = 'https://api.1inch.io/v5.0/10';
        } else {
          throw new Error('Unsupported chain for 1inch API');
        }
        
        // 获取报价
        const fromTokenAddress = fromToken.symbol === 'ETH' ? '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE' : fromToken.address;
        const toTokenAddress = toToken.symbol === 'ETH' ? '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE' : toToken.address;
        const amount = ethers.parseUnits(fromAmount.value, fromToken.decimals).toString();
        
        const quoteUrl = `${apiUrl}/quote?fromTokenAddress=${fromTokenAddress}&toTokenAddress=${toTokenAddress}&amount=${amount}`;
        
        const response = await fetch(quoteUrl);
        const quoteData = await response.json();
        
        if (!response.ok) {
          throw new Error(quoteData.description || 'Failed to get quote from 1inch');
        }
        
        // 解析报价
        const toTokenAmount = ethers.formatUnits(quoteData.toTokenAmount, toToken.decimals);
        const exchangeRateValue = quoteData.toTokenAmount / quoteData.fromTokenAmount;
        
        // 更新UI
        toAmount.value = parseFloat(toTokenAmount).toFixed(6);
        exchangeRate.textContent = `1 ${fromToken.symbol} = ${exchangeRateValue.toFixed(6)} ${toToken.symbol}`;
        
        // 启用兑换按钮
        swapBtn.disabled = false;
        swapBtnText.textContent = 'Swap';
        
        // 清除错误消息
        errorMessage.textContent = '';
      } catch (error) {
        console.error('Error getting quote:', error);
        showErrorMessage(`Failed to get quote: ${error.message}`);
        
        // 重置UI
        toAmount.value = '';
        exchangeRate.textContent = `1 ${fromToken.symbol} = 0 ${toToken.symbol}`;
        swapBtn.disabled = true;
        swapBtnText.textContent = 'Swap';
      }
    }
    
    // 19. 执行兑换
    async function executeSwap() {
      if (isSwapping) return;
      isSwapping = true;
      
      try {
        if (!walletAddress) {
          throw new Error('Please connect your wallet first');
        }
        
        if (!fromAmount.value || parseFloat(fromAmount.value) <= 0) {
          throw new Error('Please enter a valid amount');
        }
        
        if (fromToken.address === toToken.address) {
          throw new Error('Cannot swap the same token');
        }
        
        // 显示加载状态
        swapBtn.disabled = true;
        swapBtnText.innerHTML = '<div class="loading"></div>';
        
        // 获取滑点设置
        const slippage = parseFloat(slippageInput.value) || 1;
        
        // 构建1inch API URL
        const chainId = currentChainId;
        let apiUrl;
        
        if (chainId === 1) {
          apiUrl = 'https://api.1inch.io/v5.0/1';
        } else if (chainId === 56) {
          apiUrl = 'https://api.1inch.io/v5.0/56';
        } else if (chainId === 137) {
          apiUrl = 'https://api.1inch.io/v5.0/137';
        } else if (chainId === 42161) {
          apiUrl = 'https://api.1inch.io/v5.0/42161';
        } else if (chainId === 10) {
          apiUrl = 'https://api.1inch.io/v5.0/10';
        } else {
          throw new Error('Unsupported chain for 1inch API');
        }
        
        // 获取交换数据
        const fromTokenAddress = fromToken.symbol === 'ETH' ? '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE' : fromToken.address;
        const toTokenAddress = toToken.symbol === 'ETH' ? '0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE' : toToken.address;
        const amount = ethers.parseUnits(fromAmount.value, fromToken.decimals).toString();
        
        const swapUrl = `${apiUrl}/swap?fromTokenAddress=${fromTokenAddress}&toTokenAddress=${toTokenAddress}&amount=${amount}&fromAddress=${walletAddress}&slippage=${slippage}`;
        
        const response = await fetch(swapUrl);
        const swapData = await response.json();
        
        if (!response.ok) {
          throw new 错误(swapData。description || 'Failed to get swap data from 1inch');
        }
        
        // 发送交易
        const tx = await signer.sendTransaction({
          到: swapData。tx。到，
          data: swapData。tx。data，
          value: swapData.tx.value,
          gasLimit: swapData。tx。gas，
        });
        
        // 显示成功消息
        showSuccessMessage(`Transaction sent! TX Hash: ${tx.hash}`);
        
        // 等待交易确认
        const receipt = await tx.wait();
        console。log('Transaction receipt:'， receipt);
        
        // 更新余额
        updateTokenBalances();
      } catch (error) {
        console。error('Error executing swap:'， error);
        showErrorMessage(`Swap failed: ${error.message}`);
      } finally {
        // 重置按钮状态
        swapBtn。disabled = false;
        swapBtnText。textContent = 'Swap';
        isSwapping = false;
      }
    }
    
    // 20. 切换设置面板
    function toggleSettingsPanel() {
      if (settingsPanel.style.display === 'block') {
        settingsPanel.style.display = 'none';
      } else {
        settingsPanel。style。display = 'block';
      }
    }
    
    // 21. 显示错误消息
    function showErrorMessage(message) {
      errorMessage。textContent = message;
      successMessage。textContent = '';
    }
    
    // 22. 显示成功消息
    function showSuccessMessage(message) {
      successMessage。textContent = message;
      errorMessage。textContent = '';
    }
    
    // 23. 防抖函数
    function debounce(func， timeout = 300) {
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
      };
    }
    
    // 24. 初始化应用
    function initApp() {
      initEventListeners();
      
      // 检查是否已经连接了钱包
      if (window.ethereum && window.ethereum.selectedAddress) {
        connectWallet();
      }
    }
    
    // 启动应用
    window。addEventListener('DOMContentLoaded'， initApp);
  </script>
</body>
</html>
